<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>File Manager</title>
  </head>
  <body>
    <p>Wait for a reload after clicking any buttons. Errors are printed to the console</p>

    <div id="providers">
      <input type="text" id="provider-new" name="auth" value="~zod">
      <input type="submit" id="provider-submit-add" value="add provider">
      <input type="submit" id="provider-submit-remove" value="remove provider">
    </div>
    <br/>

    <div id="uploads">
      <input type="submit" id="upload-submit" value="request upload to">
      <select name="provider" id="upload-provider"></select>
      <input type="file" id="upload-file" name="myfile">
      <br/>
      <label for="">(available providers: </label>
      <label id="upload-provider-list" for="">[]</label>
      <label for="">)</label>
    </div>
    <br/>
    <br/>

    <div id="files">

      <div>
        <input type="submit" id="submit" value="X">
        <label for="submit"><a target="_blank" href="http://localhost:8000/download/file/0vbeef">~zod / 0vbeef</a></label>
      </div>
      <br/>

    </div>
    <br/>


    <script>
     // https://stackoverflow.com/questions/247483/http-get-request-in-javascript
     function httpGetAsync(theUrl, callback, errHandle) {
       var xmlHttp = new XMLHttpRequest();
       xmlHttp.onreadystatechange = function() {
         if (xmlHttp.readyState == 4 && (xmlHttp.status == 200 || xmlHttp.status == 204))
           callback(xmlHttp);
         if (xmlHttp.readyState == 4 && (xmlHttp.status != 200 && xmlHttp.status != 204))
           errHandle();
       }
       xmlHttp.open("GET", theUrl, true); // true for asynchronous
       xmlHttp.withCredentials = true;
       xmlHttp.send(null);
     }
     function httpPostAsync(theUrl, body, callback, errHandle) {
       var xmlHttp = new XMLHttpRequest();
       xmlHttp.onreadystatechange = function() {
         if (xmlHttp.readyState == 4 && (xmlHttp.status == 200 || xmlHttp.status == 204))
           callback(xmlHttp);
         if (xmlHttp.readyState == 4 && (xmlHttp.status != 200 && xmlHttp.status != 204))
           errHandle(xmlHttp);
       }
       xmlHttp.open("POST", theUrl, true); // true for asynchronous
       xmlHttp.send(body);
     }

     let providerNew = document.getElementById("provider-new");
     let providerSubmit = document.getElementById("provider-submit-add");
     let providerSubmitRemove = document.getElementById("provider-submit-remove");

     let uploadSubmit = document.getElementById("upload-submit");
     let uploadProvider = document.getElementById("upload-provider");
     let uploadProviderList = document.getElementById("upload-provider-list");

     providerSubmit.addEventListener("click", function() {
       httpPostAsync("http://localhost:8081/spider/noun/lfs-client-action/json.json",
         JSON.stringify(["add-provider", providerNew.value]),
         function(xmlhttp) {
           console.log("Add Provder response is:", xmlhttp.response);
           window.location.reload();
         },
         function() {
           console.error("Add provider failed?");
       });
     });
     providerSubmitRemove.addEventListener("click", function() {
       httpPostAsync("http://localhost:8081/spider/noun/lfs-client-action/json.json",
         JSON.stringify(["remove-provider", providerNew.value]),
         function(xmlhttp) {
           console.log("Remove Provder response is:", xmlhttp.response);
           window.location.reload();
         },
         function() {
           console.error("RFemove provider failed?");
         });
     });

     httpGetAsync("http://localhost:8081/~/scry/lfs-client/providers.json",
       function(xmlhttp) {
         let resp = JSON.parse(xmlhttp.response)
         uploadProviderList.textContent = "[" + resp.join(", ") + "]"
         resp.forEach(key => {
           let opt = document.createElement("option");
           opt.text = key;
           uploadProvider.add(opt);
         });
       },
       function() {
         console.error("Getting providers ran into some kind of error?");
       }
     );
     httpGetAsync("http://localhost:8081/~/scry/lfs-client/all-storage-info.json",
       function(xmlhttp) {
         let resp = JSON.parse(xmlhttp.response)
         console.log("add info:", resp);
       },
       function() {
         console.error("Getting storageinfo ran into some kind of error?");
       }
     );

     // function fun(ev) {
     //   submit.disabled = true;
     //   httpPostAsync("http://localhost:8081/~/login", "password="+input.value,
     //     function(xmlhttp) {
     //       submit.disabled = false;
     //     },
     //     function(xmlhttp) {
     //       submit.disabled = false;
     //       console.log("fun failure", xmlhttp);
     //     }
     //   );
     //   console.log("got event", ev);
     // }
     // submit.addEventListener("click", fun);
    </script>
  </body>
</html>
