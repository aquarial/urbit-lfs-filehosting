<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>File Manager</title>
  </head>
  <body>
    <p>Wait for a reload after clicking any buttons. Errors are printed to the console</p>

    <div id="providers">
      <input type="text" id="provider-new" name="auth" value="~zod">
      <input type="submit" id="provider-submit-add" value="add provider">
      <input type="submit" id="provider-submit-remove" value="remove provider">
    </div>
    <br/>

    <div id="uploads">
      <input type="submit" id="upload-submit" value="request upload to">
      <select name="provider" id="upload-provider"></select>
      <input type="file" id="upload-file" name="myfile">
      <br/>
      <label for="">(available providers: </label>
      <label id="upload-provider-list" for="">[]</label>
      <label for="">)</label>
    </div>
    <br/>
    <br/>

    <div id="files">

      <!--
      <h3>~zod using 3131 / 4242 bytes<h3/>
      <input type="submit" id="submit" value="X">
      <a target="_blank" href="link_to_download">~zod / 0vbeef</a>
      <br/>
      -->

    </div>
    <br/>


    <script>
     // https://stackoverflow.com/questions/247483/http-get-request-in-javascript
     function sleep(ms) {
       return new Promise(resolve => setTimeout(resolve, ms));
     }
     function httpGetAsync(theUrl, callback, errHandle) {
       var xmlHttp = new XMLHttpRequest();
       xmlHttp.onreadystatechange = function() {
         if (xmlHttp.readyState == 4 && (xmlHttp.status == 200 || xmlHttp.status == 204))
           callback(xmlHttp);
         if (xmlHttp.readyState == 4 && (xmlHttp.status != 200 && xmlHttp.status != 204))
           errHandle();
       }
       xmlHttp.open("GET", theUrl, true); // true for asynchronous
       xmlHttp.withCredentials = true;
       xmlHttp.send(null);
     }
     function httpPostAsync(theUrl, body, callback, errHandle) {
       var xmlHttp = new XMLHttpRequest();
       xmlHttp.onreadystatechange = function() {
         if (xmlHttp.readyState == 4 && (xmlHttp.status == 200 || xmlHttp.status == 204))
           callback(xmlHttp);
         if (xmlHttp.readyState == 4 && (xmlHttp.status != 200 && xmlHttp.status != 204))
           errHandle(xmlHttp);
       }
       xmlHttp.open("POST", theUrl, true); // true for asynchronous
       xmlHttp.send(body);
     }

     let providerNew = document.getElementById("provider-new");
     let providerSubmit = document.getElementById("provider-submit-add");
     let providerSubmitRemove = document.getElementById("provider-submit-remove");

     let uploadSubmit = document.getElementById("upload-submit");
     let uploadProvider = document.getElementById("upload-provider");
     let uploadProviderList = document.getElementById("upload-provider-list");
     let uploadFile = document.getElementById("upload-file");

     let storageDiv = document.getElementById("files");

     providerSubmit.addEventListener("click", function() {
       httpPostAsync("/spider/noun/lfs-client-action/json.json",
         JSON.stringify(["add-provider", providerNew.value]),
         function(xmlhttp) {
           console.log("Add Provder response is:", xmlhttp.response);
           window.location.reload();
         },
         function() {
           console.error("Add provider failed?");
       });
     });
     providerSubmitRemove.addEventListener("click", function() {
       httpPostAsync("/spider/noun/lfs-client-action/json.json",
         JSON.stringify(["remove-provider", providerNew.value]),
         function(xmlhttp) {
           console.log("Remove Provder response is:", xmlhttp.response);
           window.location.reload();
         },
         function() {
           console.error("RFemove provider failed?");
         });
     });
     uploadSubmit.addEventListener("click", function() {
       httpPostAsync("/spider/noun/lfs-client-action/json.json",
         JSON.stringify(["request-upload", uploadProvider.value]),
         async function(xmlhttp) {
           await sleep(1000);
           let resp = JSON.parse(xmlhttp.response)
           let file = uploadFile.files[0];
           console.log("uploading to", resp.url);
           httpPostAsync(resp.url, file,
             async function(xmlhttp) {
               console.log("uploading file got:", xmlhttp.response);
               await sleep(500);
               window.location.reload();
             },
             function(xmlhttp) {
               console.error("uploading file got an error?", xmlhttp.response);
             }
           );
         },
         function() {
           console.error("Request upload failed?");
         });
     });

     httpGetAsync("/~/scry/lfs-client/providers.json",
       function(xmlhttp) {
         let resp = JSON.parse(xmlhttp.response)
         uploadProviderList.textContent = "[" + resp.join(", ") + "]"
         resp.forEach(key => {
           let opt = document.createElement("option");
           opt.text = key;
           uploadProvider.add(opt);
         });
       },
       function() {
         console.error("Getting providers ran into some kind of error?");
       }
     );
     httpGetAsync("/~/scry/lfs-client/all-storage-info.json",
       function(xmlhttp) {
         let resp = JSON.parse(xmlhttp.response)
         console.log("add info:", resp);
         Object.keys(resp).forEach(provider => {
           let storage = resp[provider];
           let h3 = document.createElement("h3");
           h3.textContent = "" + provider + " using " + storage.used + " of " + storage.storage + " bytes";
           storageDiv.appendChild(h3);

           Object.keys(storage.files).forEach(fileid => {
             let file = storage.files[fileid];
             let input = document.createElement("input");
             input.type = "submit"; input.value="X";
             input.addEventListener("click", function() {
               httpPostAsync("/spider/noun/lfs-client-action/json.json",
                 JSON.stringify(["request-delete", provider, fileid]),
                 function(xmlhttp) {
                   console.log("Request delete response is:", xmlhttp.response);
                   window.location.reload();
                 },
                 function() {
                   console.error("Request delete failed?");
               });
             });
             storageDiv.appendChild(input);
             let link = document.createElement("a")
             link.target="_blank"; link.href = file['download-url']; link.textContent = "  " + provider + " / " + fileid + "  (" + file.size + " bytes)";
             storageDiv.appendChild(link);
             let br = document.createElement("br")
             storageDiv.appendChild(br);
           });
         });
       },
       function() {
         console.error("Getting storageinfo ran into some kind of error?");
       }
     );

    </script>
  </body>
</html>
